<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Voronoi Diagram</title>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.17/paper-full.min.js"></script>
	<script type="text/javascript" src="rhill-voronoi-core.js"></script>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		html, body {
			width: 100vw;
			height: 100vh;
			overflow: hidden;
			background: #fff;
		}
		body {
			display: flex;
			flex-direction: column;
			align-items: stretch;
			justify-content: stretch;
		}
		canvas {
			display: block;
			flex: 1;
			width: 100%;
			height: 100%;
			min-width: 100%;
			min-height: 100%;
		}
	</style>
</head>
<body>
	<canvas id="canvas" resize="true"></canvas>
	<script type="text/paperscript" canvas="canvas">
		var voronoi = new Voronoi();
		var sites = generateBeeHivePoints(view.size / 200, true);
		var bbox, diagram;
		var oldSize = view.size;
		var mousePos = view.center;
		var selected = false;
		
		// Load images
		var images = [];
		var imageFiles = [
			'1.png', '2.png', '3.png', '4.png', '5.png', '6.png', '7.png', '8.png',
			'9.jpg', '10.jpg', '11.jpg', '12.jpg', '13.jpg', '14.jpg', '15.jpg'
		];
		var imageCount = imageFiles.length;
		var imagesLoaded = 0;
		var siteImages = {}; // Store which image belongs to which site
		
		for (var i = 0; i < imageCount; i++) {
			var raster = new Raster('data/' + imageFiles[i]);
			raster.visible = false;
			images.push(raster);
			raster.onLoad = function() {
				imagesLoaded++;
				if (imagesLoaded === imageCount) {
					// Assign random image to each initial site
					for (var j = 0; j < sites.length; j++) {
						siteImages[j] = Math.floor(Math.random() * imageCount);
					}
					onResize();
				}
			};
		}

		function onMouseDown(event) {
			siteImages[sites.length] = Math.floor(Math.random() * imageCount);
			sites.push(event.point);
			renderDiagram();
		}

		function onMouseMove(event) {
			mousePos = event.point;
			if (event.count == 0) {
				siteImages[sites.length] = Math.floor(Math.random() * imageCount);
				sites.push(event.point);
			}
			sites[sites.length - 1] = event.point;
			renderDiagram();
		}

		function renderDiagram() {
			project.activeLayer.children = [];
			var diagram = voronoi.compute(sites, bbox);
			if (diagram) {
				for (var i = 0, l = sites.length; i < l; i++) {
					var cell = diagram.cells[sites[i].voronoiId];
					if (cell) {
						var halfedges = cell.halfedges,
							length = halfedges.length;
						if (length > 2) {
							var points = [];
							for (var j = 0; j < length; j++) {
								v = halfedges[j].getEndpoint();
								points.push(new Point(v));
							}
							createPath(points, sites[i], i);
						}
					}
				}
			}
		}

		function removeSmallBits(path) {
			var averageLength = path.length / path.segments.length;
			var min = path.length / 50;
			for(var i = path.segments.length - 1; i >= 0; i--) {
				var segment = path.segments[i];
				var cur = segment.point;
				var nextSegment = segment.next;
				var next = nextSegment.point + nextSegment.handleIn;
				if (cur.getDistance(next) < min) {
					segment.remove();
				}
			}
		}

		function generateBeeHivePoints(size, loose) {
			var points = [];
			var col = view.size / size;
			for(var i = -1; i < size.width + 1; i++) {
				for(var j = -1; j < size.height + 1; j++) {
					var point = new Point(i, j) / new Point(size) * view.size + col / 2;
					if(j % 2)
						point += new Point(col.width / 2, 0);
					if(loose)
						point += (col / 4) * Point.random() - col / 4;
					points.push(point);
				}
			}
			return points;
		}
		function createPath(points, center, siteIndex) {
			var path = new Path();
			path.closed = true;

			for (var i = 0, l = points.length; i < l; i++) {
				var point = points[i];
				var next = points[(i + 1) == points.length ? 0 : i + 1];
				var vector = (next - point) / 2;
				path.add({
					point: point + vector,
					handleIn: -vector,
					handleOut: vector
				});
			}
			path.scale(0.95);
			removeSmallBits(path);
			
			// Use assigned image for this site
			if (images.length > 0 && siteImages[siteIndex] !== undefined) {
				var imageIndex = siteImages[siteIndex];
				var assignedImage = images[imageIndex];
				var bounds = path.bounds;
				var clonedRaster = assignedImage.clone();
				clonedRaster.position = bounds.center;
				clonedRaster.visible = true;
				
				// Scale image to cover the cell
				var scale = Math.max(bounds.width / clonedRaster.width, bounds.height / clonedRaster.height) * 1.2;
				clonedRaster.scale(scale);
				
				// Create a clipping group with the path as the mask
				var group = new Group([path, clonedRaster]);
				group.clipped = true;
				
				return group;
			} else {
				path.fillColor = new Color('red');
				return path;
			}
		}

		function onResize() {
			var margin = 10;
			bbox = {
				xl: margin,
				xr: view.bounds.width - margin,
				yt: margin,
				yb: view.bounds.height - margin
			};
			for (var i = 0, l = sites.length; i < l; i++) {
				sites[i] = sites[i] * view.size / oldSize;
			}
			oldSize = view.size;
			renderDiagram();
		}

		function onKeyDown(event) {
			if (event.key == 'space') {
				selected = !selected;
				renderDiagram();
			}
		}
	</script>
</body>
</html>
